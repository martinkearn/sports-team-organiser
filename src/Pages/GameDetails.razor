@page "/games/{GameRowKey}"
@inject IPlayerService PlayerService
@inject IGameService GameService
@inject ITransactionService TransactionService
@inject NavigationManager Navigation

<PageTitle>TNF - @pageTitle</PageTitle>

<h1><i class="fa-solid fa-people-group me-2"></i> @pageTitle</h1>

<p>Forecast: @game.PlayersAtGame.Where(p => p.PlayerAtGameEntity.Forecast == PlayingOptions.Yes.ToString()).Count() yes / @game.PlayersAtGame.Where(p => p.PlayerAtGameEntity.Forecast == PlayingOptions.Maybe.ToString()).Count() maybe <br> Actual: @game.PlayersAtGame.Where(p => p.PlayerAtGameEntity.Played == true).Count()</p>

@if (currentTab == "game")
{
    <ul class="nav nav-tabs">
        <li class="nav-item">
            <a class="nav-link active" @onclick="SwitchTabGame">Game</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" @onclick="SwitchTabPlayers">Players</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" @onclick="SwitchTabTeams">Teams</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" @onclick="SwitchTabTransactions">Transactions</a>
        </li>
    </ul>

    <h4>Add Player to Game</h4>
    <div class="pb-4">
        <EditForm Model="@newPagEntity" OnValidSubmit="AddPagEntity" class="row row-cols-lg-auto g-3 align-items-center">
            <DataAnnotationsValidator />
            <ValidationSummary />
            <div class="col-12">
                <InputSelect class="form-select" @bind-Value="newPagEntity.PlayerRowKey">
                    <option value="">Select player ...</option>
                    @foreach (var player in players)
                    {
                        if (game.PlayersAtGame.FirstOrDefault(pag => pag.PlayerAtGameEntity.PlayerRowKey == player.PlayerEntity.RowKey) == default)
                        {
                            <option value="@player.PlayerEntity.RowKey">@player.PlayerEntity.Name</option>
                        }
                    }
                </InputSelect>
            </div>
            <div class="col-12">
                <button type="submit" class="btn btn-secondary"><i class="fa-solid fa-plus"></i> Add Player to Game</button>
            </div>
        </EditForm>
    </div>

    <hr>

    <h4>Add Player Payment Transaction</h4>
    <div class="pb-4">
        <EditForm Model="@newPagTransactionEntity" OnValidSubmit="AddPagTransaction" class="row row-cols-lg-auto g-3 align-items-center">
            <DataAnnotationsValidator />
            <ValidationSummary />
            <div class="col-12">
                <InputSelect class="form-select" @bind-Value="newPagTransactionEntity.PlayerRowKey" @oninput="NewPagTransactionPlayerChanged">
                    <option value="">Select player ...</option>
                    @foreach (var player in players)
                    {
                        if (game.PlayersAtGame.SingleOrDefault(pag => pag.PlayerAtGameEntity.PlayerRowKey == player.PlayerEntity.RowKey) != default)
                        {
                            <option value="@player.PlayerEntity.RowKey">@player.PlayerEntity.Name</option>
                        }
                    }
                </InputSelect>
            </div>
            <div class="col-12">
                <button type="submit" class="btn btn-secondary"><i class="fa-solid fa-plus"></i> Add Transaction</button>
            </div>
        </EditForm>
    </div>

    <hr>

    <h4>Teams</h4>
    <div class="pb-4">
        <a class="btn btn-secondary me-3 mb-3" href="/teamsheet/@game.GameEntity.RowKey"><i class="fa-solid fa-rectangle-list"></i> Teamsheet</a>
        <button class="btn btn-secondary  me-3 mb-3" @onclick="CalculateTeams"><i class="fa-solid fa-gear"></i> Calculate Teams</button>
    </div>
}

@if (currentTab == "players")
{
    <ul class="nav nav-tabs">
        <li class="nav-item">
            <a class="nav-link" @onclick="SwitchTabGame">Game</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" @onclick="SwitchTabPlayers">Players</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" @onclick="SwitchTabTeams">Teams</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" @onclick="SwitchTabTransactions">Transactions</a>
        </li>
    </ul>

    <h4>Players at Game</h4>
    <table class="table table-striped">
        <thead>
            <tr>
                <th scope="col">Name</th>
                <th scope="col" class="d-none d-lg-table-cell">Position</th>
                <th scope="col" class="d-none d-lg-table-cell">Playing</th>
                <th scope="col" class="d-none d-lg-table-cell">Balance</th>
                <th scope="col">Played</th>
                <th scope="col">Team</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var pag in game.PlayersAtGame)
            {
                <tr>
                    <td><a href="/pags/@pag.PlayerAtGameEntity.RowKey">@pag.Player.PlayerEntity.Name</a></td>
                    <td class="d-none d-lg-table-cell">@pag.Player.PlayerEntity.Position</td>
                    <td class="d-none d-lg-table-cell">
                        <InputSelect class="form-select" @bind-Value=pag.PlayerAtGameEntity.Forecast @bind-Value:after="() => EditPagEntity(pag.PlayerAtGameEntity)" >
                            <option value="Yes">Yes</option>
                            <option value="Maybe">Maybe</option>
                        </InputSelect>
                    </td>
                    <td class="d-none d-lg-table-cell"><CurrencyDisplay Amount="@pag.Player.Transactions.Sum(o => o.Amount)" /></td>
                    <td>
                        <div class="form-check form-switch">
                            <InputCheckbox class="form-check-input" type="checkbox" role="switch" @bind-Value=pag.PlayerAtGameEntity.Played @bind-Value:after="() => BillRefundPagEntity(pag.PlayerAtGameEntity)"></InputCheckbox>
                        </div>
                    </td>
                    <td>@pag.PlayerAtGameEntity.Team</td>
                </tr>
            }
        </tbody>
    </table>
}

@if (currentTab == "teams")
{
    <ul class="nav nav-tabs">
        <li class="nav-item">
            <a class="nav-link" @onclick="SwitchTabGame">Game</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" @onclick="SwitchTabPlayers">Players</a>
        </li>
        <li class="nav-item">
            <a class="nav-link active" @onclick="SwitchTabTeams">Teams</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" @onclick="SwitchTabTransactions">Transactions</a>
        </li>
    </ul>

    @if ((game.TeamA != null) && (game.TeamB != null))
    {
        <h4>Team A - @game.TeamA.Count()</h4>
        <p>@game.TeamA.Where(t => t.Player.PlayerEntity.Position == PlayerPosition.Defender).Count() defenders, @game.TeamA.Where(t => t.Player.PlayerEntity.Position == PlayerPosition.Midfielder).Count() midfielders, @game.TeamA.Where(t => t.Player.PlayerEntity.Position == PlayerPosition.Forward).Count() forwards</p>
        <table class="table table-striped">
            <thead>
                <tr>
                    <th scope="col">Player</th>
                    <th scope="col">Position</th>
                    <th scope="col" class="d-none d-lg-table-cell">Playing</th>
                    <th scope="col">Switch Team</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var pag in game.TeamA)
                {
                    <tr>
                        <td><a href="/pags/@pag.PlayerAtGameEntity.RowKey">@pag.Player.PlayerEntity.Name</a></td>
                        <td>@pag.Player.PlayerEntity.Position</td>
                        <td class="d-none d-lg-table-cell">@pag.PlayerAtGameEntity.Forecast</td>
                        <td><button class="btn btn-outline-secondary" @onclick="() => SwitchPagTeam(pag.PlayerAtGameEntity)"><i class="fa-solid fa-repeat"></i></button></td>
                    </tr>
                }
            </tbody>
        </table>

        <h4>Team B - @game.TeamB.Count()</h4>
        <p>@game.TeamB.Where(t => t.Player.PlayerEntity.Position == PlayerPosition.Defender).Count() defenders, @game.TeamB.Where(t => t.Player.PlayerEntity.Position == PlayerPosition.Midfielder).Count() midfielders, @game.TeamB.Where(t => t.Player.PlayerEntity.Position == PlayerPosition.Forward).Count() forwards</p>
        <table class="table table-striped">
            <thead>
                <tr>
                    <th scope="col">Player</th>
                    <th scope="col">Position</th>
                    <th scope="col" class="d-none d-lg-table-cell">Playing</th>
                    <th scope="col">Switch Team</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var pag in game.TeamB)
                {
                    <tr>
                        <td><a href="/pags/@pag.PlayerAtGameEntity.RowKey">@pag.Player.PlayerEntity.Name</a></td>
                        <td>@pag.Player.PlayerEntity.Position</td>
                        <td class="d-none d-lg-table-cell">@pag.PlayerAtGameEntity.Forecast</td>
                        <td><button class="btn btn-outline-secondary" @onclick="() => SwitchPagTeam(pag.PlayerAtGameEntity)"><i class="fa-solid fa-repeat"></i></button></td>
                    </tr>
                }
            </tbody>
        </table>

        @if (pagsNoTeam.Count() > 0)
        {
            <h4>Players without a team</h4>
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th scope="col">Player</th>
                        <th scope="col">Position</th>
                        <th scope="col" class="d-none d-lg-table-cell">Playing</th>
                        <th scope="col">Assign Team</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var pag in pagsNoTeam)
                    {
                        <tr>
                            <td><a href="/pags/@pag.PlayerAtGameEntity.RowKey">@pag.Player.PlayerEntity.Name</a></td>
                            <td>@pag.Player.PlayerEntity.Position</td>
                            <td class="d-none d-lg-table-cell">@pag.PlayerAtGameEntity.Forecast</td>
                            <td>
                                <button class="btn btn-outline-secondary" @onclick="() => AssignToTeamA(pag.PlayerAtGameEntity)"> <i class="fa-solid fa-a"></i> </button>
                                <button class="btn btn-outline-secondary" @onclick="() => AssignToTeamB(pag.PlayerAtGameEntity)"> <i class="fa-solid fa-b"></i> </button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        }
    }  
    else
    {
        <p>No teams yet.</p>
    }
}

@if (currentTab == "transactions")
{
    <ul class="nav nav-tabs">
        <li class="nav-item">
            <a class="nav-link" @onclick="SwitchTabGame">Game</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" @onclick="SwitchTabPlayers">Players</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" @onclick="SwitchTabTeams">Teams</a>
        </li>
        <li class="nav-item">
            <a class="nav-link active" @onclick="SwitchTabTransactions">Transactions</a>
        </li>
    </ul>

    <h4>Transactions for Game</h4>
    <table class="table table-striped">
        <thead>
            <tr>
                <th scope="col">Date/Time</th>
                <th scope="col">Amount</th>
                <th scope="col">Player</th>
                <th scope="col" class="d-none d-lg-table-cell">Player at Game</th>
                <th scope="col" class="d-none d-lg-table-cell">Notes</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var transactionEntityForGame in game.TransactionsEntities)
            {
                <tr>
                    <td><a href="/transactions/@transactionEntityForGame.RowKey">@transactionEntityForGame.Date.ToString("dd MMM yyyy HH:mm")</a></td>
                    <td><CurrencyDisplay Amount="@transactionEntityForGame.Amount" /></td>
                    <td><a href="/players/@transactionEntityForGame.PlayerRowKey">@players.SingleOrDefault(o => o.PlayerEntity.RowKey == transactionEntityForGame.PlayerRowKey).PlayerEntity.Name</a></td>
                    @{var pagForTransaction = game.PlayersAtGame.SingleOrDefault(o => o.Player.PlayerEntity.RowKey == transactionEntityForGame.PlayerRowKey);}
                    @if (pagForTransaction != default)
                    {
                        <td class="d-none d-lg-table-cell"><a href="/pags/@pagForTransaction.PlayerAtGameEntity.RowKey">@pagForTransaction.Player.PlayerEntity.Name</a></td>
                    }
                    else
                    {
                        <td class="d-none d-lg-table-cell">No player at game</td>
                    }
                    <td class="d-none d-lg-table-cell">@transactionEntityForGame.Notes</td>
                </tr>
            }
        </tbody>
    </table>

    <h4>Players to chase</h4>
    <p>Players that do not have enough funds on account to cover this game.</p>
    @foreach (var pagLowFunds in game.PlayersAtGame.Where(o => o.Player.Balance < o.Player.PlayerEntity.DefaultRate))
    {
        <p>@pagLowFunds.Player.PlayerEntity.Name, <CurrencyDisplay Amount="@pagLowFunds.Player.Transactions.Sum(o => o.Amount)" /> on account</p>
    }
}

<div class="modal-footer">
    <a class="btn btn-secondary" href="/games/"><i class="fa-solid fa-arrow-left"></i> All Games</a>
    <button class="btn btn-secondary" @onclick="DeleteGame"><i class="fa-solid fa-trash"></i> Delete Game</button>
</div>

@code {
    [Parameter]
    public string GameRowKey { get; set; }

    private Game game;

    private List<Player> players = new();

    private string currentTab = "game";

    private PlayerAtGameEntity newPagEntity;

    private TransactionEntity newPagTransactionEntity;

    private List<PlayerAtGame> pagsNoTeam;

    private string pageTitle;

    protected override async Task OnInitializedAsync()
    {
        await RefreshData();
    }

    private async Task AddPagEntity()
    {
        await GameService.UpsertPlayerAtGameEntity(newPagEntity);
        await RefreshData();
    }

    private async Task AddPagTransaction()
    {
        await TransactionService.UpsertTransactionEntity(newPagTransactionEntity);
        await RefreshData();
    }

    private void NewPagTransactionPlayerChanged(ChangeEventArgs e)
    {
        if (e.Value != null)
        {
            var player = PlayerService.GetPlayer(e.Value.ToString());
            newPagTransactionEntity.Amount = player.PlayerEntity.DefaultRate;
        }
    }

    private async Task EditPagEntity(PlayerAtGameEntity pag)
    {
        await GameService.UpsertPlayerAtGameEntity(pag);
        await RefreshData();
    }

    async Task BillRefundPagEntity(PlayerAtGameEntity pag)
    {
        // Get player for pag
        var player = PlayerService.GetPlayer(pag.PlayerRowKey);

        // Add / remove transactions if played / not played
        if (pag.Played)
        {
            var transaction = new TransactionEntity()
            {
                PlayerRowKey = pag.PlayerRowKey,
                Amount = -player.PlayerEntity.DefaultRate,
                Date = DateTimeOffset.UtcNow,
                GameRowKey = pag.GameRowKey,
                Notes = $"Debited for game {game.GameEntity.Date.Date.ToShortDateString()}"
            };
            await TransactionService.UpsertTransactionEntity(transaction);
        }
        else
        {
            // Get debit transactions (less than £0) for player and game
            var pagDebitTransactionEntities = player.Transactions
                .Where(o => o.GameRowKey == pag.GameRowKey)
                .Where(o => o.Amount < 0);
            foreach (var pagDebitTransactionEntity in pagDebitTransactionEntities)
            {
                await TransactionService.DeleteTransactionEntity(pagDebitTransactionEntity.RowKey);
            }
        }

        // Upsert pag
        await GameService.UpsertPlayerAtGameEntity(pag);

        await RefreshData();
    }

    async Task DeleteGame()
    {
        await GameService.DeleteGame(game.GameEntity.RowKey);
        Navigation.NavigateTo("/games");
    }

    async Task CalculateTeams()
    {
        var playersAtGameWithTeams = await GameService.CalculateTeams(game.PlayersAtGame);
        game.TeamA = playersAtGameWithTeams
            .Where(pag => pag.PlayerAtGameEntity.Team == "A")
            .OrderBy(o => o.Player.PlayerEntity.Name)
            .ToList();
        game.TeamB = playersAtGameWithTeams
            .Where(pag => pag.PlayerAtGameEntity.Team == "B")
            .OrderBy(o => o.Player.PlayerEntity.Name)
            .ToList();

        await RefreshData();
    }

    async Task SwitchPagTeam(PlayerAtGameEntity pag)
    {
        if (pag.Team == "A")
        {
            pag.Team = "B";
        }
        else
        {
            pag.Team = "A";
        }
        await GameService.UpsertPlayerAtGameEntity(pag);
        await RefreshData();
    }

    async Task AssignToTeamA(PlayerAtGameEntity pag)
    {
        pag.Team = "A";
        await GameService.UpsertPlayerAtGameEntity(pag);
        await RefreshData();
    }

     async Task AssignToTeamB(PlayerAtGameEntity pag)
    {
        pag.Team = "B";
        await GameService.UpsertPlayerAtGameEntity(pag);
        await RefreshData();
    }   

    async Task RefreshData()
    {
        players = PlayerService.GetPlayers();
        game = await GameService.GetGame(GameRowKey);
        newPagEntity = new PlayerAtGameEntity()
        {
            GameRowKey = game.GameEntity.RowKey,
            Played = false,
            Forecast = PlayingOptions.Yes.ToString(),
        };
        newPagTransactionEntity = new TransactionEntity()
        {
            GameRowKey = game.GameEntity.RowKey,
            Date = DateTimeOffset.UtcNow,
            Notes = $"Credited for game {game.GameEntity.Date.Date.ToShortDateString()}"
        };
        pagsNoTeam = game.PlayersAtGame.Where(o => string.IsNullOrEmpty(o.PlayerAtGameEntity.Team)).ToList();
        pageTitle = $"{game.GameEntity.Date.Date.ToString("dd MMM")}";

    }

    private void SwitchTabPlayers() => currentTab = "players";
    private void SwitchTabTransactions() => currentTab = "transactions";
    private void SwitchTabTeams() => currentTab = "teams";
    private void SwitchTabGame() => currentTab = "game";
}