@page "/transactions"
@inject ITransactionService TransactionService

<PageTitle>TNF - @_pageTitle</PageTitle>

<h1><i class="fa-solid fa-coins me-2"></i> @_pageTitle</h1>

<table class="table table-striped">
	<thead>
	<tr>
		<th scope="col">Date</th>
		<th scope="col">Amount</th>
		<th scope="col" class="d-none d-lg-table-cell">Player</th>
		<th scope="col" class="d-none d-lg-table-cell">Game</th>
		<th scope="col" class="d-none d-lg-table-cell">Notes</th>
	</tr>
	</thead>
	<tbody>
	@foreach (var t in _transactions)
	{
		<tr>
			<td><EntityTitleLink EntityType="Enums.EntityType.TransactionEntity" RowKey="@t.Id" Length="Enums.TitleLength.Long" Link="true" /></td>
			<td><CurrencyDisplay Amount="@t.Amount" /></td>
			<td class="d-none d-lg-table-cell">@t.PlayerEntity.Name</td>
			@if (t.GameEntity != null)
			{
				<td class="d-none d-lg-table-cell">
					<EntityTitleLink EntityType="Enums.EntityType.GameEntity" RowKey="@t.GameEntity.RowKey" Length="Enums.TitleLength.Short" Link="true"/>
				</td>
			}
			else
			{
				<td class="d-none d-lg-table-cell">No Game</td>
			}
			<td class="d-none d-lg-table-cell">@t.Notes</td>
		</tr>
	}
	</tbody>
</table>

<ShowMore TotalItems="@_transactions.Count" ItemsPerPage="@ItemsPerPage" ParentPageCallback="() => ShowMore(ItemsPerPage)" />

@code {
	[CascadingParameter] public MainLayout MainLayout { get; set; } = default!;

	private List<Transaction> _transactions = [];

	private const int ItemsPerPage = 30;

	private string _pageTitle = default!;

	protected override void OnInitialized()
	{
		RefreshData();
	}

	private void ShowMore(int itemsPerPage)
	{
		var addedTransactions = TransactionService
			.GetTransactions(_transactions.Count, itemsPerPage)
			.ToList();
		
		_transactions.AddRange(addedTransactions);
	}

	private void RefreshData()
	{
		_transactions = TransactionService
			.GetTransactions(0, ItemsPerPage)
			.ToList();
		
		_pageTitle = "Transactions";
		MainLayout.SetPageTitle(_pageTitle);
	}
}